#!/usr/bin/env bash
# Complete current TODO and start the next one
# Usage: jj-todo-done [NEXT_REV]
#
# NEXT_REV is required to actually move to the next task.
# If not provided, shows the current task's specs and lists possible next TODOs.
#
# Example:
#   jj-todo-done         # Show specs of current as reminder and list next options
#   jj-todo-done abc123  # Mark current done, start working on abc123

set -euo pipefail

SCRIPTS_DIR="$(dirname "$0")"

if [[ -z "${1:-}" ]]; then
    # No argument provided - remind of specs and show next options
    echo "ðŸ“‹ REVIEW the current TODO specs to make sure everything is implemented as required:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    "$SCRIPTS_DIR/jj-show-desc" @
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo ""

    # Find children that are TODOs
    children="$(jj log -r "children(@) & description(substring:\"[todo]\")" --no-graph -T 'change_id.shortest(8) ++ "\n"')"

    if [[ -z "$children" ]]; then
        echo "No pending TODO children found. You may be done with this chain!"
        echo "Check remaining TODOs with: jj-find-flagged todo"
    else
        echo "Next TODOs available:"
        echo ""
        while IFS= read -r child; do
            [[ -z "$child" ]] && continue
            title="$(jj log -r "$child" --no-graph -T 'description.first_line()')"
            echo "  $child  $title"
        done <<< "$children"
        echo ""
        echo "ONCE YOU ARE READY TO MOVE ON TO ANOTHER TASK, run again with the ID of the next TODO to start: jj-todo-done <change-id>"
    fi
else
    # Use specified next revision - complete current and start next
    next="$1"

    # Mark current as done
    "$SCRIPTS_DIR/jj-flag-update" @ done

    current=$(jj log -r @ --no-graph -T 'change_id.shortest(8)')

    jj edit "$next"
    "$SCRIPTS_DIR/jj-flag-update" @ wip
    echo ""
    echo "âœ… Completed: $current"
    echo ""
    echo "ðŸ“‹ Now starting to work on $next:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    "$SCRIPTS_DIR/jj-show-desc" @
fi
